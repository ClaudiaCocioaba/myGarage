{% extends "garage.html" %}

{% block head %}
	  {% load staticfiles %}
	  <link rel="stylesheet" href="//code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css">
      <script src="//code.jquery.com/jquery-1.10.2.js"></script>
      <script src="//code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
      
	   <script type="text/javascript">
		   $(document).ready(function () {

		        var hrefValue = "refuellings";
		        setItemMenuActive(hrefValue);
		        setColumnsWidth();
		        selectRow();


			    
		   });	

		   function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie != '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = jQuery.trim(cookies[i]);
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) == (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
           }


		   validationsArray = [];
		   digitsOnlyValidationArray = ['id_current_mileage', 'id_sum_refuelled', 'id_quantity_refuelled'];

		   //when row is selected show the trash, save and date icons
		   //the input boxes from the selected row have ids
		   function selectRow() {
                var rows = $('tr');
                rows.on('click', function(e){
                    var row = $(this);
                    var columns = $(this).find('td:not(:last)');

                    for(var i=0; i<columns.length; i++){
                        $(columns[i]).find('input').removeAttr('readonly');
                    }

                    unmarkPreviousSelectedRow();
                    markSelectedRow(row);

                });

                $(document).bind('selectstart dragstart', function(e) {
                    e.preventDefault(); return false;
                });
		   }

           function unmarkPreviousSelectedRow(tempRow) {
                rows = $('.records tbody').find('tr');
                rows.removeAttr('id');
                rows.find('.deleteRowBtn').css('visibility', 'hidden');
                rows.find('.saveRowBtn').css('visibility', 'hidden');

                if(tempRow) {
                    rows.find('td').children().not('.tempInput').each(function(index, element) {
                        $(element).attr('id', '');
                    });
                }else {
                    rows.find('td').children().each(function(index, element) {
                        $(element).attr('id', '');
                    });
                }

                $('.ui-datepicker-trigger').css('visibility', 'hidden');
           }

		   function markSelectedRow(row) {
		        row.attr('id', 'selectedRow');
                row.find('.deleteRowBtn').css('visibility', 'visible');
                row.find('.saveRowBtn').css('visibility', 'visible');

                $('#selectedRow').find('.ui-datepicker-trigger').css('visibility', 'visible');
                $('#selectedRow').find(".datepicker").datepicker({
                    setDate: new Date(),
                    showOtherMonths: true,
                    selectOtherMonths: true,
                    dateFormat: 'dd M. yy',
                    altField: ".altDateField",
                    altFormat: "yy-mm-dd",
                    showOn: "button",
                    buttonText: 'Show Date',
                    buttonImageOnly: true,
                    buttonImage: "/myGarageApp/static/myGarage/img/calendar.png"
                });


                 $(".ui-datepicker-trigger").mouseover(function() {
                    $(this).css('cursor', 'pointer');
                 });

                 row.find('td:not(:last())').children().not('.hasDatepicker, .ui-datepicker-trigger, .altDateField')
                                                            .each(function(index, element) {
                                                                var elemName = $(element).attr('name');
                                                                var elemID = "id_" + elemName;
                                                                $(element).attr('id', elemID);

                                                                if( digitsOnlyValidationArray.indexOf(elemID) > -1) {
                                                                        $('#' + elemID).keyup(digitsOnlyValidation);
                                                                }

                                                            });

		   }


		   function deleteRowFunction(e) {
                e.stopPropagation();

                var csrftoken = getCookie('csrftoken');
                $.ajaxSetup({
                    beforeSend: function(xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                });

                recordIDValue = $('#selectedRow input[name=pk_refuelling]');
                recordIDValue = recordIDValue.val().trim();
                 if (confirm("Are you sure you want to delete this record?") == true) {
                    $.ajax({
                        url: '/refuellings/',
                        type: 'DELETE',
                        data: {recordID: ''+recordIDValue },
                        success: function(result) {
                            $('#selectedRow').remove();
                            alert('deletion was successful');

                        },
                        error: function() {
                            alert('could not be deleted');
                        }
                    });
                 }

           }


           // clone the original inputs into a display:none form and submit
           // before cloning remove possible previous inputs
           function saveRowFunction(e) {
                e.stopPropagation();

                if (confirm("Are you sure you want to save this record?") == true) {
                    var noRemove = $('#newRefuellingForm').find('.addNewRecordTip, input[name=csrfmiddlewaretoken], input[name=pk_refuelling]');
                    $('#newRefuellingForm').empty();
                    $('#newRefuellingForm').html(noRemove);

                   var newValues = $('#selectedRow').find('td:not(:last())').clone();
                   for(var i=0; i<newValues.length; i++) {
                        var children = $(newValues[i]).children().not('.ui-datepicker-trigger, .hasDatepicker');
                        children.attr('id', '');
                        $('#newRefuellingForm').append(children);
                   }
                   var existingDate = $('#selectedRow .datepicker').val();
                   $('#newRefuellingForm input[name=refuel_date]').val(moment(new Date(existingDate)).format('YYYY-MM-DD'));

                   $('#newRefuellingForm').submit();
                }
           }

	   </script>
{% endblock %}


{% block title %}Refuellings{% endblock %}

{% block operations %}
    <input type="button" id="addRecord" onclick="addNewRow()" alt="Add new record" value="Add new row"/>

	{% if refuellings %}			
	        <table class="records">	
		        <thead>
                    <tr>
                        <th>Refuel date</th>
                        <th>Current mileage</th>
                        <th>Sum refuelled</th>
                        <th>Quantity refuelled</th>
                        <th></th>
                    </tr>
                </thead>
	        </table>   
	        <div class="tableDiv" >
		        <table class="records">
                    <tbody>
	    		    {% for record in refuellings %}
			    		<tr>
			    		    <td>
                                <input class="recordsTextInput datepicker" type="text" value="{{ record.refuel_date }}" readonly style=" width: 85%;">
                                <input class="altDateField" type="hidden" name="refuel_date">
                                <input class="" type="hidden" name="pk_refuelling" value="{{ record.id }}">
                            </td>
			    		    <td><input class="recordsTextInput" type="text" name="current_mileage" value="{{ record.current_mileage }}" readonly></td>
			    			<td><input  class="recordsTextInput" type="text" name="sum_refuelled" value="{{ record.sum_refuelled }}" readonly></td>
			    			<td><input  class="recordsTextInput" type="text" name="quantity_refuelled" value="{{ record.quantity_refuelled }}" readonly></td>
			    			<td>
                                <div class="rowOptions">
                                    <input type="button" class="saveRowBtn" onclick="saveRowFunction(event)" alt="Save record"/>
                                    <input type="button" class="deleteRowBtn" onclick="deleteRowFunction(event)" alt="Delete record"/>
                                </div>
                            </td>
			    		</tr>
	    		    {% endfor %}
                    </tbody>
	    		</table>
    		</div>
    	{% else %}	
    		<p>no refuellings for this car</p>   		  
   		{% endif %}


    <form id="newRefuellingForm" method="post" action="" onsubmit="return validateTempFields()">
        {% csrf_token %}
        <span id="id_current_mileage_tip" class='addNewRecordTip' onclick="closeValidationTip(this)"></span>
        <span id="id_sum_refuelled_tip" class='addNewRecordTip' onclick="closeValidationTip(this)"></span>
        <span id="id_quantity_refuelled_tip" class='addNewRecordTip' onclick="closeValidationTip(this)"></span>

    </form>
{% endblock %}	





{% block footer %}
{% endblock %}